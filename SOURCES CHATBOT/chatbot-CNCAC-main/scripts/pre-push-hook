#!/bin/bash

# Git pre-push hook - Run tests and clean temporary files before push
# This hook is called with the following parameters:
# $1 -- Name of the remote to which the push is being done
# $2 -- URL to which the push is being done

echo "ğŸ” Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to clean temporary files
clean_temp_files() {
    echo -e "${YELLOW}ğŸ§¹ Cleaning temporary files...${NC}"
    
    # Clean Python cache files
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find . -type f -name "*.pyc" -delete 2>/dev/null || true
    find . -type f -name "*.pyo" -delete 2>/dev/null || true
    find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
    find . -type f -name ".coverage" -delete 2>/dev/null || true
    find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
    
    # Clean Node.js temporary files
    find . -type d -name ".next" -path "*/front/*" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "dist" -path "*/front/*" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "coverage" -path "*/front/*" -exec rm -rf {} + 2>/dev/null || true
    
    # Clean IDE and OS files
    find . -type f -name ".DS_Store" -delete 2>/dev/null || true
    find . -type f -name "Thumbs.db" -delete 2>/dev/null || true
    find . -type f -name "*.swp" -delete 2>/dev/null || true
    find . -type f -name "*.swo" -delete 2>/dev/null || true
    find . -type f -name "*~" -delete 2>/dev/null || true
    
    # Clean log files
    find . -type f -name "*.log" -not -path "*/node_modules/*" -not -path "*/.git/*" -delete 2>/dev/null || true
    
    echo -e "${GREEN}âœ… Temporary files cleaned${NC}"
}

# Function to run backend tests
run_backend_tests() {
    echo -e "${YELLOW}ğŸ Running backend tests...${NC}"
    
    if [ -d "backend" ]; then
        cd backend
        
        # Check if virtual environment exists
        if [ -d "venv" ] || [ -d ".venv" ]; then
            # Activate virtual environment
            if [ -d "venv" ]; then
                source venv/bin/activate
            else
                source .venv/bin/activate
            fi
        fi
        
        # Run linting with ruff (if available)
        if command -v ruff &> /dev/null; then
            echo "Running ruff linter..."
            ruff check src/ --fix
            if [ $? -ne 0 ]; then
                echo -e "${RED}âŒ Backend linting failed${NC}"
                cd ..
                return 1
            fi
        fi
        
        # Run type checking with mypy (if available)
        if command -v mypy &> /dev/null; then
            echo "Running mypy type checker..."
            mypy src/ --ignore-missing-imports
            if [ $? -ne 0 ]; then
                echo -e "${YELLOW}âš ï¸  Backend type checking has warnings${NC}"
                # Don't fail on mypy warnings
            fi
        fi
        
        # Run tests with pytest (if available)
        if command -v pytest &> /dev/null; then
            echo "Running pytest..."
            pytest tests/ -v --tb=short
            if [ $? -ne 0 ]; then
                echo -e "${RED}âŒ Backend tests failed${NC}"
                cd ..
                return 1
            fi
        else
            echo -e "${YELLOW}âš ï¸  pytest not found, skipping backend tests${NC}"
        fi
        
        cd ..
        echo -e "${GREEN}âœ… Backend tests passed${NC}"
    fi
    
    return 0
}

# Function to run frontend tests
run_frontend_tests() {
    echo -e "${YELLOW}ğŸ“¦ Running frontend tests...${NC}"
    
    if [ -d "front" ]; then
        cd front
        
        # Check if node_modules exists
        if [ ! -d "node_modules" ]; then
            echo -e "${YELLOW}Installing frontend dependencies...${NC}"
            npm ci
        fi
        
        # Run linting (allow warnings, fail on errors)
        echo "Running ESLint..."
        npm run lint 2>&1 | tee /tmp/eslint-output.txt
        if grep -q "error" /tmp/eslint-output.txt; then
            echo -e "${RED}âŒ Frontend linting failed with errors${NC}"
            cd ..
            return 1
        else
            echo -e "${GREEN}âœ… ESLint passed (warnings allowed)${NC}"
        fi
        
        # Run type checking
        echo "Running TypeScript type checking..."
        npm run typecheck
        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ Frontend type checking failed${NC}"
            cd ..
            return 1
        fi
        
        # Run tests if available
        if npm run | grep -q "test"; then
            echo "Running frontend tests..."
            npm test -- --watchAll=false 2>/dev/null || npm test 2>/dev/null
            if [ $? -ne 0 ]; then
                echo -e "${YELLOW}âš ï¸  Frontend tests have issues${NC}"
                # Don't fail on test issues for now
            fi
        fi
        
        cd ..
        echo -e "${GREEN}âœ… Frontend checks passed${NC}"
    fi
    
    return 0
}

# Main execution
main() {
    # Get the current branch
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    echo -e "${YELLOW}ğŸ“Œ Current branch: $current_branch${NC}"
    
    # Clean temporary files first
    clean_temp_files
    
    # Run backend tests
    run_backend_tests
    backend_result=$?
    
    # Run frontend tests
    run_frontend_tests
    frontend_result=$?
    
    # Check results
    if [ $backend_result -ne 0 ] || [ $frontend_result -ne 0 ]; then
        echo -e "${RED}âŒ Pre-push checks failed. Please fix the issues before pushing.${NC}"
        echo -e "${YELLOW}ğŸ’¡ Tip: You can bypass this hook with 'git push --no-verify' (not recommended)${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}âœ… All pre-push checks passed! Proceeding with push...${NC}"
    exit 0
}

# Run main function
main